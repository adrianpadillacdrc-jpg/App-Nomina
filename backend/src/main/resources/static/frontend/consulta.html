<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>NUMA NÓMINA - Consulta</title>
  <link rel="stylesheet" href="estilos.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>

<body>
  <aside class="sidebar" id="sidebar">
    <div class="logo-container">
      <img src="assets/logc.png" alt="Logo" class="logo">
      <svg class="brand-logo" viewBox="0 0 340 100" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <style>
            .g-text {
              font-family: 'Segoe UI', Arial, sans-serif;
              font-weight: 800;
              font-size: 64px
            }

            .g-small {
              font-family: 'Segoe UI', Arial, sans-serif;
              font-weight: 700;
              font-size: 16px
            }
          </style>
        </defs>
        <text x="6" y="66" class="g-text" fill="#4a4a4f">NUMA</text>
        <g transform="translate(120,12) scale(1.6)">
          <circle cx="12" cy="20" r="10" fill="#6d5aa8" />
          <circle cx="30" cy="12" r="14" fill="#6d5aa8" />
          <circle cx="52" cy="20" r="10" fill="#6d5aa8" />
          <rect x="14" y="20" width="40" height="14" rx="7" fill="#6d5aa8" />
        </g>
        <text x="240" y="78" class="g-small" fill="#6d5aa8">nomina</text>
      </svg>
    </div>
    <nav class="menu">
      <a href="dashboard-admin.html"><i class="fa-solid fa-house"></i><span>Inicio</span></a>
      <a href="registro-empleados.html"><i class="fa-solid fa-user-plus"></i><span>Registrar</span></a>
      <a href="liquidacion-nomina.html"><i class="fa-solid fa-file-invoice-dollar"></i><span>Liquidar</span></a>
      <a href="#" class="active"><i class="fa-solid fa-magnifying-glass"></i><span>Consultar</span></a>
      <a href="novedades-empleado.html"><i class="fa-solid fa-clipboard-list"></i><span>Novedades</span></a>
      <a href="pago-nomina.html"><i class="fa-solid fa-money-check-dollar"></i><span>Pago Nómina</span></a>
      <a href="login.html" onclick="cerrarSesion()"><i class="fa-solid fa-right-from-bracket"></i><span>Salir</span></a>
    </nav>
  </aside>

  <main class="content">
    <h1>Consultar Empleados</h1>

    <input type="text" class="search-box" id="searchBox" placeholder="Buscar por nombre, apellido, documento o cargo..."
      onkeyup="filtrarTablaConsulta()" />

    <table class="table" id="tablaConsulta">
      <thead>
        <tr>
          <th>Documento</th>
          <th>Nombre</th>
          <th>Apellido</th>
          <th>Cargo</th>
          <th>Salario</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tbodyConsulta"></tbody>
    </table>
  </main>

  <div id="mensaje" class="mensaje-flotante"></div>
  <script src="js/api.js"></script>
  <script src="js/api.js"></script> <!-- SI LO TIENES, SINO USA EL DE ARRIBA -->
  <script>
    async function cargarEmpleados() {
      try {
        const res = await fetch('http://localhost:8080/api/empleado');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return await res.json();
      } catch (error) {
        console.error('Error:', error);
        mostrarMensaje('Error de conexión', 'error');
        return [];
      }
    }

    async function cargarConsulta() {
      const empleados = await cargarEmpleados();
      const tbody = document.getElementById('tbodyConsulta');
      tbody.innerHTML = '';

      if (empleados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#999;">No hay empleados registrados</td></tr>';
        return;
      }

      empleados.forEach(e => {
        const tr = document.createElement('tr');
        const estadoClase = e.estado === 'Activo' ? 'activo' : 'inactivo';
        tr.innerHTML = `
        <td>${e.numeroDocumento || '-'}</td>
        <td>${e.nombre || '-'}</td>
        <td>${e.apellido || '-'}</td>
        <td>${e.cargo || '-'}</td>
        <td>$ ${(e.salarioBase || 0).toLocaleString('es-CO')}</td>
        <td><span class="status ${estadoClase}">${e.estado || 'Pendiente'}</span></td>
        <td>
          <button class="btn-edit" onclick="editar(${e.id})">
            <i class="fa-solid fa-edit"></i> Editar
          </button>
          <button class="btn-delete" onclick="eliminar(${e.id})">
            <i class="fa-solid fa-trash"></i> Eliminar
          </button>
        </td>
      `;
        tbody.appendChild(tr);
      });
    }

    function editar(id) {
      window.location.href = `editar-empleado.html?id=${id}`;
    }

    function eliminar(id) {
      if (confirm('¿Eliminar este empleado?')) {
        fetch(`http://localhost:8080/api/empleado/${id}`, { method: 'DELETE' })
          .then(() => {
            mostrarMensaje('Empleado eliminado', 'exito');
            cargarConsulta();
          })
          .catch(() => mostrarMensaje('Error al eliminar', 'error'));
      }
    }

    function filtrarTablaConsulta() {
      const term = document.getElementById('searchBox').value.toLowerCase();
      const rows = document.querySelectorAll('#tbodyConsulta tr');
      rows.forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(term) ? '' : 'none';
      });
    }

    function mostrarMensaje(texto, tipo = 'exito') {
      const msg = document.getElementById('mensaje');
      msg.textContent = texto;
      msg.className = `mensaje-flotante ${tipo} mostrar`;
      setTimeout(() => msg.className = 'mensaje-flotante', 3000);
    }

    document.addEventListener('DOMContentLoaded', cargarConsulta);
  </script>